<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Soil Transport PDF Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; padding: 20px; }
    .container { max-width: 850px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #1a73e8; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 25px 0; }
    label { font-weight: 600; font-size: 14px; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; margin-top: 5px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; border: 1px solid #dee2e6; text-align: center; }
    th { background: #f8f9fa; }
    .actions { margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end; align-items: center; }
    button { padding: 12px 24px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; }
    .add { background: #e8f0fe; color: #1a73e8; }
    .pdf { background: #34a853; color: #fff; }
    .total { margin-top: 20px; font-size: 20px; font-weight: bold; text-align: right; }
    #loadingMsg { color: #d93025; font-weight: bold; display: none; }
  </style>
</head>
<body>

<div class="container">
  <div style="text-align:right;">
    <select id="language" onchange="setLanguage()">
      <option value="en">English</option>
      <option value="mr" selected>मराठी</option>
    </select>
  </div>

  <h1 id="title">माती वाहतूक करार अहवाल</h1>

  <div class="grid">
    <div>
      <label id="vendorLabel">विक्रेता नाव</label>
      <input id="vendor" />
    </div>
    <div>
      <label id="vendorContactLabel">विक्रेता संपर्क क्रमांक</label>
      <input id="vendorContact" type="tel" />
    </div>
    <div>
      <label id="contractorLabel">ठेकेदार नाव</label>
      <input id="contractor" />
    </div>
    <div>
      <label id="contractorContactLabel">ठेकेदार संपर्क क्रमांक</label>
      <input id="contractorContact" type="tel" />
    </div>
  </div>

  <table id="tripTable">
    <thead>
      <tr>
        <th id="thTrip">फेरीचे वर्णन</th>
        <th id="thCost">प्रति फेरी खर्च</th>
        <th id="thTrips">फेऱ्यांची संख्या</th>
        <th id="thTotal">एकूण खर्च</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input /></td>
        <td><input type="number" value="0" oninput="calculate()" /></td>
        <td><input type="number" value="0" oninput="calculate()" /></td>
        <td class="rowTotal">0</td>
      </tr>
    </tbody>
  </table>

  <div class="actions">
    <span id="loadingMsg">कृपया प्रतीक्षा करा, फॉन्ट लोड होत आहे...</span>
    <button class="add" onclick="addTrip()" id="addTripBtn">फेरी जोडा</button>
    <button class="pdf" onclick="generatePDF()" id="pdfBtn">PDF डाउनलोड करा</button>
  </div>

  <div class="total" id="grandTotal">एकूण रक्कम: 0</div>
</div>

<script>
const translations = {
  en: { title: 'Soil Transportation Contract Report', vendor: 'Vendor Name', vCon: 'Vendor Contact', contractor: 'Contractor Name', cCon: 'Contractor Contact', trip: 'Trip Description', cost: 'Cost/Trip', qty: 'Trips', total: 'Total', add: 'Add Trip', pdf: 'Generate PDF', grand: 'Grand Total' },
  mr: { title: 'माती वाहतूक करार अहवाल', vendor: 'विक्रेता नाव', vCon: 'विक्रेता संपर्क', contractor: 'ठेकेदार नाव', cCon: 'ठेकेदार संपर्क', trip: 'फेरीचे वर्णन', cost: 'प्रति फेरी खर्च', qty: 'फेऱ्यांची संख्या', total: 'एकूण खर्च', add: 'फेरी जोडा', pdf: 'PDF डाउनलोड करा', grand: 'एकूण रक्कम' }
};

function setLanguage() {
  const lang = document.getElementById('language').value;
  const t = translations[lang];
  document.getElementById('title').innerText = t.title;
  document.getElementById('vendorLabel').innerText = t.vendor;
  document.getElementById('vendorContactLabel').innerText = t.vCon;
  document.getElementById('contractorLabel').innerText = t.contractor;
  document.getElementById('contractorContactLabel').innerText = t.cCon;
  document.getElementById('thTrip').innerText = t.trip;
  document.getElementById('thCost').innerText = t.cost;
  document.getElementById('thTrips').innerText = t.qty;
  document.getElementById('thTotal').innerText = t.total;
  document.getElementById('addTripBtn').innerText = t.add;
  document.getElementById('pdfBtn').innerText = t.pdf;
  calculate();
}

function addTrip() {
  const tbody = document.querySelector('#tripTable tbody');
  const row = document.createElement('tr');
  row.innerHTML = `<td><input /></td><td><input type="number" value="0" oninput="calculate()" /></td><td><input type="number" value="0" oninput="calculate()" /></td><td class="rowTotal">0</td>`;
  tbody.appendChild(row);
}

function calculate() {
  let grand = 0;
  document.querySelectorAll('#tripTable tbody tr').forEach(row => {
    const cost = Number(row.children[1].querySelector('input').value) || 0;
    const qty = Number(row.children[2].querySelector('input').value) || 0;
    const total = cost * qty;
    row.querySelector('.rowTotal').innerText = total;
    grand += total;
  });
  const lang = document.getElementById('language').value;
  document.getElementById('grandTotal').innerText = `${translations[lang].grand}: ${grand}`;
}

async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const lang = document.getElementById('language').value;
  const t = translations[lang];
  
  const loader = document.getElementById('loadingMsg');
  loader.style.display = 'inline';

  try {
    // 1. Load Font
    const fontUrl = 'https://raw.githubusercontent.com/googlefonts/noto-fonts/main/hinted/ttf/NotoSansDevanagari/NotoSansDevanagari-Regular.ttf';
    const resp = await fetch(fontUrl);
    const buff = await resp.arrayBuffer();
    const base64 = btoa(new Uint8Array(buff).reduce((data, byte) => data + String.fromCharCode(byte), ''));
    
    doc.addFileToVFS('NotoSans.ttf', base64);
    doc.addFont('NotoSans.ttf', 'MarathiFont', 'normal');
    doc.setFont('MarathiFont');

    // 2. Header
    doc.setFontSize(20);
    doc.setTextColor(26, 115, 232);
    doc.text(t.title, 105, 20, { align: 'center' });

    // 3. User Details (Formatted with better spacing)
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    let yPos = 40;
    const leftMargin = 14;

    doc.text(`${t.vendor}: ${document.getElementById('vendor').value}`, leftMargin, yPos);
    doc.text(`${t.vCon}: ${document.getElementById('vendorContact').value}`, 120, yPos);
    yPos += 10;
    doc.text(`${t.contractor}: ${document.getElementById('contractor').value}`, leftMargin, yPos);
    doc.text(`${t.cCon}: ${document.getElementById('contractorContact').value}`, 120, yPos);

    // 4. Table
    const tableData = [];
    document.querySelectorAll('#tripTable tbody tr').forEach(row => {
      tableRows = [
        row.children[0].querySelector('input').value || '-',
        row.children[1].querySelector('input').value,
        row.children[2].querySelector('input').value,
        row.querySelector('.rowTotal').innerText
      ];
      tableData.push(tableRows);
    });

    doc.autoTable({
      startY: yPos + 10,
      head: [[t.trip, t.cost, t.qty, t.total]],
      body: tableData,
      styles: { font: 'MarathiFont', fontSize: 10, cellPadding: 5 },
      headStyles: { fillColor: [26, 115, 232], textColor: [255, 255, 255], fontStyle: 'normal' },
      theme: 'grid'
    });

    // 5. Footer
    const finalY = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(14);
    doc.text(document.getElementById('grandTotal').innerText, 196, finalY, { align: 'right' });

    doc.save('Report.pdf');
  } catch (err) {
    alert("Error generating PDF. Please check your internet connection for fonts.");
    console.error(err);
  } finally {
    loader.style.display = 'none';
  }
}
</script>
</body>
</html>
